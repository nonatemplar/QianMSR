DEFINE MODULE AzureAnalytics
BEGIN

REFERENCE @"/shares/AzureAnalytics.Prod/Sdk/Consolidatedv1.14/Bond.Attributes.dll";
REFERENCE @"/shares/AzureAnalytics.Prod/Sdk/Consolidatedv1.14/Bond.dll";
REFERENCE @"/shares/AzureAnalytics.Prod/Sdk/Consolidatedv1.14/Bond.IO.dll";
REFERENCE @"/shares/AzureAnalytics.Prod/Sdk/Consolidatedv1.14/Dial.Authentication.dll";
REFERENCE @"/shares/AzureAnalytics.Prod/Sdk/Consolidatedv1.14/MFx.Nova.Api.Client.dll";
REFERENCE @"/shares/AzureAnalytics.Prod/Sdk/Consolidatedv1.14/Microsoft.Azure.Analytics.DirectoryContracts.dll";
REFERENCE @"/shares/AzureAnalytics.Prod/Sdk/Consolidatedv1.14/Microsoft.Azure.Analytics.ScopeExtensions.dll";
REFERENCE @"/shares/AzureAnalytics.Prod/Sdk/Consolidatedv1.14/Microsoft.Data.Edm.dll";
REFERENCE @"/shares/AzureAnalytics.Prod/Sdk/Consolidatedv1.14/Microsoft.Data.OData.dll";
REFERENCE @"/shares/AzureAnalytics.Prod/Sdk/Consolidatedv1.14/Microsoft.Data.Services.Client.dll";
REFERENCE @"/shares/AzureAnalytics.Prod/Sdk/Consolidatedv1.14/Microsoft.IdentityModel.Clients.ActiveDirectory.dll";
REFERENCE @"/shares/AzureAnalytics.Prod/Sdk/Consolidatedv1.14/Microsoft.IdentityModel.dll";
REFERENCE @"/shares/AzureAnalytics.Prod/Sdk/Consolidatedv1.14/Newtonsoft.Json.dll";
REFERENCE @"/shares/AzureAnalytics.Prod/Sdk/Consolidatedv1.14/System.Net.Http.Formatting.dll";
REFERENCE @"/shares/AzureAnalytics.Prod/Sdk/Consolidatedv1.14/System.Spatial.dll";


    RESOURCE @"/shares/AzureAnalytics.Prod/Sdk/Common/creds.txt";
    RESOURCE @"/shares/AzureAnalytics.Prod/Sdk/Common/PrivateVCConfig.config";

    VIEW Initialize
    RETURN ROWSET (dummy:string)
    PARAMS
    (
        entity string
    );

    VIEW LoadStream
    PARAMS
    (
        entity string,
        startDateTime string,
        endDateTime string,
        omitVirtualColumns bool DEFAULT = true
    );

    VIEW LoadStreamStrict
    PARAMS
    (
        entity string,
        startDateTime string,
        endDateTime string,
        omitVirtualColumns bool DEFAULT = true
    );

    VIEW LoadSnapshot
    PARAMS
    (
        entity string,
        snapshotDateTime string DEFAULT = "",
        omitVirtualColumns bool DEFAULT = true
    );

    VIEW LoadSnapshotStrict
    PARAMS
    (
        entity string,
        snapshotDateTime string DEFAULT = "",
        omitVirtualColumns bool DEFAULT = true
    );

    FUNC DeltaToSnapshot;

    PROC PublishStream;

    PROC PublishSnapshot;
END MODULE

VIEW Initialize
RETURN
    ROWSET
    (
        dummy : string
    )
PARAMS
(
    entity string
)
BEGIN
#DECLARE nsLength int = @entity.LastIndexOf('.');
#DECLARE entityNamespace string = @nsLength < 0 ? string.Empty : @entity.Substring(0, @nsLength);
#DECLARE entityName string = @entity.Substring(@nsLength + 1);
#DECLARE filenameWithoutNamespacePath string = @"/shares/AzureAnalytics.Dev/AzureAnalytics.Dev.Local.DataSources/" + @entityNamespace + "/" + @entityName.Substring(0, @entityName.Contains("V") ? @entityName.LastIndexOf("V") : @entityName.Length) + "/schemas/" + @entityName + ".module";
#DECLARE filenameWithNamespacePath string = @"/shares/AzureAnalytics.Dev/AzureAnalytics.Dev.Local.DataSources/" + @entityNamespace + "/" + @entityName.Substring(0, @entityName.Contains("V") ? @entityName.LastIndexOf("V") : @entityName.Length) + "/schemas/" + @entityNamespace + "." + @entityName + ".module";
#IF (EXISTS(@filenameWithNamespacePath))
    MODULE @filenameWithNamespacePath AS schemas;
#ELSEIF (EXISTS(@filenameWithoutNamespacePath))
    MODULE @filenameWithoutNamespacePath AS schemas;
#ENDIF 
  dummyRs = EXTRACT dummy : string
    FROM @"/local/streamset?sparsestreamset=true"
    USING DefaultTextExtractor();
END VIEW

VIEW LoadStream
PARAMS
(
    entity string,
    startDateTime string,
    endDateTime string,
    omitVirtualColumns bool DEFAULT = true
)
USING Microsoft.Azure.Analytics.ScopeExtensions.EntityResolver("https://novamanifest.api.msdial.com/novamanifestservice.svc/", "module");

VIEW LoadStreamStrict
PARAMS
(
    entity string,
    startDateTime string,
    endDateTime string,
    omitVirtualColumns bool DEFAULT = true
)
USING Microsoft.Azure.Analytics.ScopeExtensions.EntityResolver("https://novamanifest.api.msdial.com/novamanifestservice.svc/", "module", "strict");

VIEW LoadSnapshot
PARAMS
(
    entity string,
    snapshotDateTime string DEFAULT = "",
    omitVirtualColumns bool DEFAULT = true
)
USING Microsoft.Azure.Analytics.ScopeExtensions.EntityResolver("https://novamanifest.api.msdial.com/novamanifestservice.svc/", "module", "snapshot");

VIEW LoadSnapshotStrict
PARAMS
(
    entity string,
    snapshotDateTime string DEFAULT = "",
    omitVirtualColumns bool DEFAULT = true
)
USING Microsoft.Azure.Analytics.ScopeExtensions.EntityResolver("https://novamanifest.api.msdial.com/novamanifestservice.svc/", "module", "snapshot", "strict");

FUNC DeltaToSnapshot USING Microsoft.Azure.Analytics.ScopeExtensions.DeltaToSnapshotResolver("https://novamanifest.api.msdial.com/novamanifestservice.svc/");

PROC PublishStream USING Microsoft.Azure.Analytics.ScopeExtensions.PublishEntityResolver("https://novamanifest.api.msdial.com/novamanifestservice.svc/");

PROC PublishSnapshot USING Microsoft.Azure.Analytics.ScopeExtensions.PublishEntityResolver("https://novamanifest.api.msdial.com/novamanifestservice.svc/", "snapshot");
