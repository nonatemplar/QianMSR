//Script GUID:89808eab-216f-4b30-8367-3e41572cd044
//Used for tracking history

MODULE @"/shares/AzureAnalytics.Prod/Sdk/AzureAnalytics1.3.module" AS AzureAnalytics;             
             
AzureAnalytics.Initialize(             
	entity = "Microsoft.Azure.Compute.VmAvailabilityDataHourly");             
             
a = AzureAnalytics.LoadStream(             
	entity = "Microsoft.Azure.Compute.VmAvailabilityDataHourly",             
	startDateTime = "2014-10-01",
	endDateTime = "2015-06-17");          

rawData=
    SELECT *
    FROM a
    WHERE RoleType=="IaaSDurable";

vm_list=
    SELECT LogicalContainerId, COUNT(*) AS DTcounts 
    FROM rawData
    GROUP BY LogicalContainerId
    HAVING DTcounts>=2;

timeStamp = 

    SELECT rawData.LogicalContainerId, PreciseTimeStamp
    FROM rawData, vm_list
    WHERE rawData.LogicalContainerId==vm_list.LogicalContainerId;

rc =
    REDUCE timeStamp
    ON LogicalContainerId
    PRODUCE LogicalContainerId,
            InitTime,
            LastTime
    USING SampleReducer
    PRESORT PreciseTimeStamp;

OUTPUT rc TO @"/my/jobs/VM_DT_lifetime_iaas.txt" USING DefaultTextOutputter();
//OUTPUT rc TO SSTREAM @"/my/jobs/VM_DT_lifetime_2DT.ss";
#CS

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

public class SampleReducer : Reducer
{

     public override Schema Produces(string[] columns, string[] args, Schema input)

     {

          return new Schema("LogicalContainerId:string, InitTime: DateTime, LastTime: DateTime");  

     }

 

    public override IEnumerable<Row> Reduce(RowSet input, Row output, string[] args)
    {
        
          bool first = true;

          string LogicalContainerId = "";

          DateTime initTime=new DateTime();


          DateTime lastTime=new DateTime();

          foreach (Row row in input.Rows)

          {

              if (first)

              {
                   LogicalContainerId=row[0].String;

                   initTime=row[1].DateTime;
                   lastTime=row[1].DateTime;
                   
                   first = false;

              }
              else {
                  lastTime=row[1].DateTime;
              }

              
          }

          output[0].Set(LogicalContainerId);

          output[1].Set(initTime);

          output[2].Set(lastTime);

          yield return output;

     }

}
#ENDCS